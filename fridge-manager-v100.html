<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>冷蔵庫管理 v1.0.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        /* レイアウト固定設定 */
        :root {
            --primary-color: #4CAF50;
            --bg-color: #f4f4f4;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            /* iOSズーム防止 */
            touch-action: manipulation;
            overflow-x: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
        }

        /* 1. カメラエリア (上部固定) */
        #camera-section {
            position: relative;
            width: 100%;
            height: 40vh;
            background: #000;
            overflow: hidden;
        }

        #interactive.viewport {
            width: 100%;
            height: 100%;
        }

        #interactive.viewport video, canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* スキャンガイド枠 */
        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            z-index: 10;
        }

        /* 2. 操作エリア (中央) */
        #control-section {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            color: white;
            background-color: var(--primary-color);
            cursor: pointer;
            touch-action: manipulation;
        }

        button:active {
            opacity: 0.7;
        }

        .input-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 18px;
        }

        /* 3. 在庫リストエリア (下部) */
        #list-section {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .item-card {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 5px solid var(--primary-color);
        }

        #status-log {
            font-size: 11px;
            color: #888;
            padding: 5px;
            background: #eee;
        }
    </style>
</head>
<body>

<div id-app-container>
    <div id="camera-section">
        <div id="interactive" class="viewport"></div>
        <div class="scan-guide"></div>
    </div>

    <div id="status-log">Status: 待機中...</div>

    <div id="control-section">
        <div class="btn-group">
            <button onclick="startBarcodeScan()">バーコード</button>
            <button onclick="captureForOCR()">賞味期限読込</button>
        </div>
        <div class="input-group">
            <label>バーコード / 商品名</label>
            <input type="text" id="product-code" placeholder="スキャンまたは入力">
        </div>
        <div class="input-group">
            <label>賞味期限</label>
            <input type="text" id="expiry-date" placeholder="YYYY-MM-DD">
        </div>
        <button onclick="saveItem()" style="background: #2196F3; width: 100%;">冷蔵庫に入れる</button>
    </div>

    <div id="list-section">
        <h3 style="margin-top: 0;">在庫リスト</h3>
        <div id="inventory-list"></div>
    </div>
</div>

<script>
    const logElement = document.getElementById('status-log');
    const productInput = document.getElementById('product-code');
    const expiryInput = document.getElementById('expiry-date');

    function updateLog(msg, isError = false) {
        logElement.innerText = `Status: ${msg}`;
        if (isError) console.error(`[App Error] ${msg}`);
        else console.log(`[App Info] ${msg}`);
    }

    // --- バーコードスキャン (QuaggaJS) ---
    function startBarcodeScan() {
        updateLog("バーコードスキャナ起動中...");
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment"
                }
            },
            decoder: {
                readers: ["ean_reader", "ean_8_reader"]
            }
        }, function(err) {
            if (err) {
                updateLog(`起動失敗: ${err.name}`, true);
                return;
            }
            Quagga.start();
            updateLog("バーコード読み取り中...");
        });

        Quagga.onDetected((data) => {
            productInput.value = data.codeResult.code;
            updateLog("バーコード検出成功！");
            Quagga.stop();
        });
    }

    // --- 賞味期限読込 (Tesseract.js OCR) ---
    async function captureForOCR() {
        updateLog("画像解析中 (Tesseract)...");
        
        const video = document.querySelector('video');
        if (!video) {
            updateLog("カメラが起動していません。バーコードボタンを先に押してください。", true);
            return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        try {
            const result = await Tesseract.recognize(canvas, 'eng', {
                logger: m => console.log(m)
            });
            // 数字と日付記号っぽいものを抽出
            const dateMatch = result.data.text.match(/\d{2,4}[./-]\d{1,2}[./-]\d{1,2}/);
            if (dateMatch) {
                expiryInput.value = dateMatch[0];
                updateLog("日付を抽出しました");
            } else {
                expiryInput.value = result.data.text.substring(0, 10); // 候補として一部表示
                updateLog("日付が見つかりませんでした。テキストを抽出します。");
            }
        } catch (e) {
            updateLog(`OCRエラー: ${e.message}`, true);
        }
    }

    // --- 保存機能 ---
    function saveItem() {
        const item = {
            code: productInput.value,
            expiry: expiryInput.value,
            date: new Date().toLocaleString()
        };
        
        if(!item.code) {
            alert("商品名またはコードを入力してください");
            return;
        }

        const list = document.getElementById('inventory-list');
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `<strong>${item.code}</strong><br>期限: ${item.expiry}<br><small>登録: ${item.date}</small>`;
        list.prepend(card);
        
        // 入力クリア
        productInput.value = "";
        expiryInput.value = "";
        updateLog("保存しました");
    }

    // 初期化時にカメラパーミッション確認用ダミー
    window.onload = () => {
        updateLog("ライブラリロード完了。スキャンを開始してください。");
    };
</script>

</body>
</html>
